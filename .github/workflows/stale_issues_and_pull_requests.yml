---
name: ðŸ•µï¸ Manage Stale Issues and Pull Requests

on:
  schedule:
    - cron: "00 03 * * *"

  workflow_dispatch:
    inputs:
      days_before_stale_issue:
        description: "Days of inactivity before marking an issue as stale"
        required: true
        default: 11
        type: number
      days_before_close_issue:
        description: "Days after stale before closing the issue"
        required: true
        default: 3
        type: number
      days_before_stale_pull_request:
        description: "Days of inactivity before marking an pull request as stale"
        required: true
        default: 25
        type: number
      days_before_close_pull_request:
        description: "Days after stale before closing the pull request"
        required: true
        default: 3
        type: number

permissions:
  issues: write
  pull-requests: write

jobs:
  stale:
    name: ðŸ§¹ Manage issues and pull requests
    runs-on: ubuntu-latest

    if: |
      github.event.sender.type != 'Bot' &&
      !contains(github.actor, '[bot]')

    env:
      DAYS_BEFORE_STALE_ISSUES: ${{ github.event.inputs.days_before_stale_issue || '11' }}
      DAYS_BEFORE_CLOSE_ISSUES: ${{ github.event.inputs.days_before_close_issue || '3' }}
      DAYS_BEFORE_STALE_PRS: ${{ github.event.inputs.days_before_stale_pull_request || '25' }}
      DAYS_BEFORE_CLOSE_PRS: ${{ github.event.inputs.days_before_close_pull_request || '3' }}

    steps:
      - name: ðŸ Notify start of process
        run: |
          echo "::notice title=Workflow started::ðŸ” Stale processing started"
          echo "::group::â„¹ï¸ Execution context"
          echo "Repository: ${{ github.repository }}"
          echo "Workflow ref: ${{ github.ref }}"
          echo "Runner OS: ${{ runner.os }}"
          echo "::endgroup::"

      - name: ðŸ” Process stale issues
        id: stale-issues
        uses: actions/stale@v10.2.0
        with:
          stale-issue-message: |
            ## ðŸ‘‹ Just checking in

            This issue has been inactive for **${{ env.DAYS_BEFORE_STALE_ISSUES }} days**, so weâ€™re giving it a gentle nudge ðŸ•°ï¸

            ### â³ What happens next?

            - If thereâ€™s no activity within **${{ env.DAYS_BEFORE_CLOSE_ISSUES }} days**, this issue will be closed automatically.
            - Any comment or update will remove the **stale** label.

            Thanks for helping keep the project tidy! ðŸ™Œ

          close-issue-message: |
            ## ðŸš« Issue closed due to inactivity

            This issue was automatically closed after being marked **stale** and receiving no further activity.

            ### ðŸ’¡ Still relevant?

            - Feel free to reopen this issue, or
            - Open a new one with updated context

            Thanks for your understanding!

          days-before-stale: "${{ env.DAYS_BEFORE_STALE_ISSUES }}"
          days-before-close: "${{ env.DAYS_BEFORE_CLOSE_ISSUES }}"

          stale-issue-label: "stale"

          exempt-issue-labels: |
            bug
            discussion
            discussion required
            documentation
            P0: critical
            P1: high
            P2: moderate
            cannot reproduce
            in progress
            under development
            security
            security vulnerability
            releaseblocker

          exempt-issue-assignees: |
            homelab-alpha

          operations-per-run: 1000

      - name: ðŸ” Process stale pull requests
        id: stale-prs
        uses: actions/stale@v10.2.0
        with:
          stale-pr-message: |
            ## ðŸ‘‹ Just checking in

            This pull request has been inactive for **${{ env.DAYS_BEFORE_STALE_PRS }} days**, so weâ€™re giving it a gentle nudge ðŸ•°ï¸
            No worries â€” we just want to check whether itâ€™s still in progress. ðŸ˜Š

            ### â³ What happens next?

            - If thereâ€™s no activity within **${{ env.DAYS_BEFORE_CLOSE_PRS }} days**, this pull request will be closed automatically.
            - Any new commit, review, or comment will remove the **stale** label.

            Thanks again for your contribution â€” we appreciate the effort! ðŸš€

          close-pr-message: |
            ## ðŸš« Pull request closed due to inactivity

            This pull request was automatically closed after being marked **stale** and receiving no further activity.

            ### ðŸ’¡ Still relevant?

            - Feel free to reopen the pull request, or
            - Open a new one when youâ€™re ready.

            Thanks for taking the time to contribute â€” we hope to see you again! ðŸ™Œ

          days-before-pr-stale: "${{ env.DAYS_BEFORE_STALE_PRS }}"
          days-before-pr-close: "${{ env.DAYS_BEFORE_CLOSE_PRS }}"

          stale-pr-label: "stale"

          exempt-pr-assignees: |
            homelab-alpha

          exempt-pr-labels: |
            in progress
            under development
            security
            security vulnerability
            releaseblocker

          operations-per-run: 1000

      - name: ðŸš¨ Log execution failure
        if: failure()
        run: |
          echo "::error title=Stale Management Failed::âŒ The stale processing job encountered an error while updating issues or PRs. Check logs for API rate limits or permission issues."

      - name: ðŸ“Š Generate job summary
        if: always()
        run: |
          echo "::group::ðŸ“Š Generating Summary Report"

          ISSUE_RESULT="${{ steps.stale-issues.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }}"
          PR_RESULT="${{ steps.stale-prs.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }}"

          {
            echo "## ðŸ•µï¸ Stale Management Summary"
            echo ""
            echo "Execution completed at: $(date -u)"
            echo ""
            echo "### ðŸ“ˆ Execution Results"
            echo ""
            echo "| Target | Action | Result |"
            echo "| :--- | :--- | :--- |"
            echo "| ðŸŽ« Issues | Processed | $ISSUE_RESULT |"
            echo "| ðŸ—ï¸ Pull Requests | Processed | $PR_RESULT |"
            echo ""
            echo "### âš™ï¸ Runtime Configuration"
            echo ""
            echo "- **Issue Stale Threshold:** ${{ env.DAYS_BEFORE_STALE_ISSUES }} days"
            echo "- **PR Stale Threshold:** ${{ env.DAYS_BEFORE_STALE_PRS }} days"
            echo "- **Close Grace Period:** ${{ env.DAYS_BEFORE_CLOSE_ISSUES }} days"
            echo ""
            echo "### ðŸ§© Notes"
            echo ""
            echo "- Workflow Run: [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          } >> "$GITHUB_STEP_SUMMARY"

          echo "::endgroup::"
