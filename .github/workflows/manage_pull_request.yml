---
name: Manage Pull Requests

on:
  pull_request:
    branches:
      - main
    types:
      - closed
      - labeled
      - opened
      - ready_for_review
      - reopened

  pull_request_review:
    types:
      - submitted

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  handel:
    if: |
      github.event.sender.type != 'Bot' &&
      !contains(github.actor, '[bot]') &&
      github.event.pull_request.user.type != 'Bot'

    runs-on: ubuntu-latest

    env:
      GITHUB_TOKEN: ${{ github.token }}
      PR_NUMBER: ${{ github.event.pull_request.number }}
      REPO: ${{ github.repository }}

      LABEL_BACKLOG: "backlog"
      LABEL_EXTERNAL_FEEDBACK: "external feedback"
      LABEL_FIX_REQUESTED: "PR: please address review comments"
      LABEL_IN_PROGRESS: "in progress"
      LABEL_NEEDS_REVIEW: "PR: needs review"
      LABEL_P3_LOW: "P3: low"
      LABEL_REOPEN: "reopen"
      LABEL_WONTFIX: "wontfix"

    steps:
      - name: Ensure Pull Request is draft
        if: |
          (
            github.event_name == 'pull_request' &&
            (
              github.event.action == 'opened' ||
              github.event.action == 'reopened' ||
              (
                github.event.action == 'labeled' &&
                github.event.label.name == 'PR: please address review comments'
              )
            )
          ) ||
          (
            github.event_name == 'pull_request_review' &&
            github.event.review.state == 'changes_requested' &&
            (
              github.event.review.author_association == 'MEMBER' ||
              github.event.review.author_association == 'OWNER'
            )
          )

        run: |
          echo "::notice title=Ensuring Draft Status::üîÑ Checking if PR is draft..."
          echo ""
          echo "‚ñ∂Ô∏è Evaluating whether the pull request should be set to draft‚Ä¶"
          echo "‚ÑπÔ∏è Checking current draft status‚Ä¶"

          IS_DRAFT=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json isDraft -q '.isDraft')

          if [ "$IS_DRAFT" = "false" ]; then
            echo "::notice title=Converting to Draft::üîÑ Converting pull request to draft‚Ä¶"
            echo ""
            echo "üîÑ Converting pull request to draft‚Ä¶"
            gh pr ready "$PR_NUMBER" --repo "$REPO" --undo
          else
            echo "::notice title=Already Draft::‚è≠Ô∏è Pull request is already in draft state; no action needed."
            echo ""
            echo "‚è≠Ô∏è Pull request is already in draft state; no action needed."
          fi

      - name: New Pull Request
        if: |
          github.event_name == 'pull_request' &&
          github.event.action == 'opened'

        run: |
          echo "::notice title=New Pull Request Opened::üöÄ A new pull request has been opened. The team will review it soon."
          echo ""
          echo "‚ñ∂Ô∏è New pull request opened."
          echo "‚ÑπÔ∏è Applying initial workflow labels‚Ä¶"

          gh pr edit "$PR_NUMBER" --repo "$REPO" \
            --remove-label "$LABEL_BACKLOG" \
            --remove-label "$LABEL_EXTERNAL_FEEDBACK" \
            --remove-label "$LABEL_FIX_REQUESTED" \
            --remove-label "$LABEL_NEEDS_REVIEW" \
            --remove-label "$LABEL_P3_LOW" \
            --remove-label "$LABEL_WONTFIX" \
            --add-label "$LABEL_IN_PROGRESS" || true

          echo "::notice title=Welcome Message::üí¨ Posting welcome message to the pull request‚Ä¶"
          echo ""
          echo "üí¨ Posting welcome message to the pull request‚Ä¶"

          gh pr comment "$PR_NUMBER" --repo "$REPO" --body "
          ## üëã Hello there, and thank you for your contribution! üéâ

          We appreciate your pull request ‚Äî your support helps the project grow! üöÄ
          Our team will review your submission as soon as possible.

          ### üîç Before requesting a review, please make sure that:

          - üìù All relevant documentation is updated.
          - üß™ All necessary tests are included and passing.
          - ‚úÖ CI/CD workflows complete successfully.

          ### üí° Still working on changes?

          No problem! This pull request is automatically kept in **Draft** while work is still in progress.
          Once all changes are complete and the pull request is ready to be reviewed, mark it as **Ready for review**.

          If you have any questions about the design or contribution process,
          feel free to ask them right here in this pull request ‚Äî unclear documentation is a bug too! üòâ

          Thank you again for your time and effort. We‚Äôre looking forward to reviewing your pull request! üôå
          "

      - name: Reopened Pull Request
        if: |
          github.event_name == 'pull_request' &&
          github.event.action == 'reopened'

        run: |
          echo "::notice title=Pull Request Reopened::üîÑ This pull request has been reopened and is now under review."
          echo ""
          echo "‚ñ∂Ô∏è Pull request reopened."
          echo "‚ÑπÔ∏è Restoring active workflow labels‚Ä¶"

          gh pr edit "$PR_NUMBER" --repo "$REPO" \
            --remove-label "$LABEL_BACKLOG" \
            --remove-label "$LABEL_EXTERNAL_FEEDBACK" \
            --remove-label "$LABEL_FIX_REQUESTED" \
            --remove-label "$LABEL_NEEDS_REVIEW" \
            --remove-label "$LABEL_P3_LOW" \
            --remove-label "$LABEL_WONTFIX" \
            --add-label "$LABEL_IN_PROGRESS" \
            --add-label "$LABEL_REOPEN" || true

      - name: Changes requested
        if: |
          (
            (
              github.event_name == 'pull_request' &&
              github.event.action == 'labeled' &&
              github.event.label.name == 'PR: please address review comments'
            ) ||
            (
              github.event_name == 'pull_request_review' &&
              github.event.review.state == 'changes_requested' &&
              (
                github.event.review.author_association == 'MEMBER' ||
                github.event.review.author_association == 'OWNER'
              )
            )
          )

        run: |
          echo "::notice title=Changes Requested::‚ö†Ô∏è Changes requested by a maintainer."
          echo ""
          echo "‚ñ∂Ô∏è Changes requested by a maintainer."
          echo "‚ÑπÔ∏è Updating labels to reflect requested changes‚Ä¶"

          gh pr edit "$PR_NUMBER" --repo "$REPO" \
            --remove-label "$LABEL_BACKLOG" \
            --remove-label "$LABEL_EXTERNAL_FEEDBACK" \
            --remove-label "$LABEL_NEEDS_REVIEW" \
            --remove-label "$LABEL_P3_LOW" \
            --remove-label "$LABEL_WONTFIX" \
            --add-label "$LABEL_FIX_REQUESTED" \
            --add-label "$LABEL_IN_PROGRESS" || true

      - name: External review (non-maintainers)
        if: |
          github.event_name == 'pull_request_review' &&
          github.event.review.state == 'changes_requested' &&
          github.event.review.author_association != 'MEMBER' &&
          github.event.review.author_association != 'OWNER'

        run: |
          echo "::notice title=External Review Requested::üìù Changes requested by an external reviewer."
          echo ""
          echo "‚ñ∂Ô∏è Changes requested by an external reviewer."
          echo "‚ÑπÔ∏è Applying external feedback label‚Ä¶"

          gh pr edit "$PR_NUMBER" --repo "$REPO" \
            --remove-label "$LABEL_BACKLOG" \
            --remove-label "$LABEL_FIX_REQUESTED" \
            --remove-label "$LABEL_IN_PROGRESS" \
            --remove-label "$LABEL_NEEDS_REVIEW" \
            --remove-label "$LABEL_P3_LOW" \
            --remove-label "$LABEL_WONTFIX" \
            --add-label "$LABEL_EXTERNAL_FEEDBACK" || true

      - name: Ready for review
        if: |
          github.event_name == 'pull_request' &&
          github.event.action == 'ready_for_review'

        run: |
          echo "::notice title=Pull Request Ready for Review::‚úÖ The pull request has been marked as ready for review."
          echo ""
          echo "‚ñ∂Ô∏è Pull request marked as ready for review."
          echo "‚ÑπÔ∏è Updating labels for review state‚Ä¶"

          gh pr edit "$PR_NUMBER" --repo "$REPO" \
            --remove-label "$LABEL_BACKLOG" \
            --remove-label "$LABEL_EXTERNAL_FEEDBACK" \
            --remove-label "$LABEL_FIX_REQUESTED" \
            --remove-label "$LABEL_IN_PROGRESS" \
            --remove-label "$LABEL_P3_LOW" \
            --remove-label "$LABEL_WONTFIX" \
            --add-label "$LABEL_NEEDS_REVIEW" || true

      - name: Backlog label
        if: |
          github.event_name == 'pull_request' &&
          github.event.action == 'labeled' &&
          github.event.label.name == 'backlog'

        run: |
          echo "::notice title=Added to Backlog::üóÇÔ∏è This PR has been added to the backlog."
          echo ""
          echo "‚ñ∂Ô∏è Pull request added to the backlog."
          echo "‚ÑπÔ∏è Adjusting labels and priority indicators‚Ä¶"

          gh pr edit "$PR_NUMBER" --repo "$REPO" \
            --remove-label "$LABEL_EXTERNAL_FEEDBACK" \
            --remove-label "$LABEL_FIX_REQUESTED" \
            --remove-label "$LABEL_IN_PROGRESS" \
            --remove-label "$LABEL_NEEDS_REVIEW" \
            --remove-label "$LABEL_WONTFIX" \
            --add-label "$LABEL_BACKLOG" \
            --add-label "$LABEL_P3_LOW" || true

          echo "::notice title=Backlog Status::üí¨ Notifying contributor about backlog status‚Ä¶"
          echo ""
          echo "üí¨ Notifying contributor about backlog status‚Ä¶"

          gh pr comment "$PR_NUMBER" --repo "$REPO" --body "
          ## üóÇÔ∏è This PR has been added to the backlog

          This pull request has been labeled as **'backlog'** and will be reviewed and prioritized at a later time.

          ### ‚è≥ What happens next

          - We‚Äôll revisit this PR when it comes up in the backlog prioritization.
          - Feel free to follow up with any new information or context as needed.

          üí¨ If you think this PR should be prioritized sooner, feel free to comment with any updates or feedback.

          Thanks for your patience and for contributing to the project! üôè
          "

      - name: Wontfix label
        if: |
          github.event_name == 'pull_request' &&
          github.event.action == 'labeled' &&
          github.event.label.name == 'wontfix'

        run: |
          echo "::notice title=Pull Request Marked 'Wontfix'::üö´ This PR has been marked as 'wontfix'."
          echo ""
          echo "‚ñ∂Ô∏è Pull request marked as 'wontfix'."
          echo "‚ÑπÔ∏è Cleaning up labels before closing‚Ä¶"

          gh pr edit "$PR_NUMBER" --repo "$REPO" \
            --remove-label "$LABEL_BACKLOG" \
            --remove-label "$LABEL_EXTERNAL_FEEDBACK" \
            --remove-label "$LABEL_FIX_REQUESTED" \
            --remove-label "$LABEL_IN_PROGRESS" \
            --remove-label "$LABEL_NEEDS_REVIEW" \
            --remove-label "$LABEL_P3_LOW" \
            --add-label "$LABEL_WONTFIX" || true

          echo "::notice title=Closing PR::üö´ Closing pull request and notifying contributor‚Ä¶"
          echo ""
          echo "üö´ Closing pull request and notifying contributor‚Ä¶"

          gh pr close "$PR_NUMBER" --repo "$REPO" --delete-branch --comment "
          ## üö´ This PR has been marked as 'wontfix'

          Unfortunately, this PR will not be pursued any further.

          We truly appreciate your contribution, and we hope to collaborate with you on future improvements! üôè

          Thanks for understanding!
          "

      - name: Unmerged Pull Request (cleanup labels)
        if: |
          github.event_name == 'pull_request' &&
          github.event.action == 'closed' &&
          github.event.pull_request.merged == false

        run: |
          echo "::notice title=Pull Request Closed Without Merge::‚ùå This PR was closed without being merged."
          echo ""
          echo "‚ñ∂Ô∏è Pull request closed without merge."
          echo "‚ÑπÔ∏è Removing workflow and status labels‚Ä¶"

          gh pr edit "$PR_NUMBER" --repo "$REPO" \
            --remove-label "$LABEL_BACKLOG" \
            --remove-label "$LABEL_EXTERNAL_FEEDBACK" \
            --remove-label "$LABEL_FIX_REQUESTED" \
            --remove-label "$LABEL_IN_PROGRESS" \
            --remove-label "$LABEL_NEEDS_REVIEW" \
            --remove-label "$LABEL_P3_LOW" \
            --remove-label "$LABEL_REOPEN" \
            --remove-label "$LABEL_WONTFIX" || true

          echo "::notice title=Closure Notice::üí¨ Posting closure notice to the pull request‚Ä¶"
          echo ""
          echo "üí¨ Posting closure notice to the pull request‚Ä¶"

          gh pr comment "$PR_NUMBER" --repo "$REPO" --body "
          ## ‚ùå Pull request closed (not merged)

          This pull request has been closed without being merged.

          üßπ To keep things tidy, we‚Äôve removed any workflow and status labels associated with this PR.

          ### üí° Want to continue?

          - Feel free to reopen this pull request if you plan to continue the work, or
          - Open a new PR when you‚Äôre ready with updated changes or context

          Thanks for the time and effort you put into this contribution ‚Äî we appreciate it! üôå
          "

      - name: Merged Pull Request (cleanup labels)
        if: |
          github.event_name == 'pull_request' &&
          github.event.action == 'closed' &&
          github.event.pull_request.merged == true

        run: |
          echo "::notice title=Pull Request Merged::üéâ This pull request has been successfully merged."
          echo ""
          echo "‚ñ∂Ô∏è Pull request successfully merged."
          echo "‚ÑπÔ∏è Performing post-merge label cleanup‚Ä¶"

          gh pr edit "$PR_NUMBER" --repo "$REPO" \
            --remove-label "$LABEL_BACKLOG" \
            --remove-label "$LABEL_EXTERNAL_FEEDBACK" \
            --remove-label "$LABEL_FIX_REQUESTED" \
            --remove-label "$LABEL_IN_PROGRESS" \
            --remove-label "$LABEL_NEEDS_REVIEW" \
            --remove-label "$LABEL_P3_LOW" \
            --remove-label "$LABEL_REOPEN" \
            --remove-label "$LABEL_WONTFIX" || true

          echo "::notice title=Thanking Contributor::üéâ Thanking contributor for the merged pull request‚Ä¶"
          echo ""
          echo "üéâ Thanking contributor for the merged pull request‚Ä¶"

          gh pr comment "$PR_NUMBER" --repo "$REPO" --body "
          ## ‚úÖ Pull request merged

          Great news ‚Äî this pull request has been successfully merged! üéâ

          üßπ As part of the cleanup, we‚Äôve removed workflow and status labels that are no longer needed.

          ### üôå Thank you for contributing

          Your effort helps keep the project moving forward and improving.
          We really appreciate the time and care you put into this change!

          Looking forward to your next contribution üöÄ
          "
