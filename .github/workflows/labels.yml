---
name: ðŸ·ï¸ Synchronize Repository Labels

on:
  push:
    branches:
      - main
    paths:
      - .github/labels.yml

  workflow_dispatch:
    inputs:
      dry_run:
        description: "Run in dry-run mode"
        required: true
        default: false
        type: boolean

permissions:
  contents: read
  issues: write

concurrency:
  group: labels-${{ github.repository || github.run_id }}
  cancel-in-progress: true

jobs:
  labels:
    name: ðŸ·ï¸ Manage Labels
    runs-on: ubuntu-latest

    if: |
      github.event.sender.type != 'Bot' &&
      !contains(github.actor, '[bot]')

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      REPO: ${{ github.repository }}
      LABELS_FILE: .github/labels.yml
      DRY_RUN: >-
        ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run || 'false' }}

    steps:
      - name: ðŸ Notify start of process
        run: |
          echo "::notice title=Workflow started::ðŸ·ï¸ Label synchronization initiated"
          echo "::group::â„¹ï¸ Execution context"
          echo "Repository: $REPO"
          echo "Mode: $( [ "$DRY_RUN" = "true" ] && echo "DRY-RUN" || echo "ACTIVE" )"
          echo "::endgroup::"

      - name: ðŸ“¦ Download Labels Configuration
        uses: actions/checkout@v6.0.2
        with:
          sparse-checkout: .github/labels.yml

      - name: â„¹ï¸ Load Desired Labels
        id: load_labels
        run: |
          set -euo pipefail
          echo "::group::â„¹ï¸ Loading Desired Labels"
          echo "ðŸ” Reading $LABELS_FILE"

          if [ ! -f "$LABELS_FILE" ]; then
            echo "::error title=Configuration Missing::âŒ The file $LABELS_FILE was not found."
            exit 1
          fi

          yq -o=json '.' "$LABELS_FILE" | jq 'unique_by(.name)' > /tmp/desired-labels.json

          echo "âœ… Desired labels loaded:"
          cat /tmp/desired-labels.json
          echo "::endgroup::"

      - name: ðŸ” Fetch Existing Repository Labels
        id: fetch_labels
        run: |
          set -euo pipefail
          echo "::group::ðŸ” Fetching Existing Labels"

          if ! gh label list --repo "$REPO" --limit 5000 --json name,color,description > /tmp/existing-labels.json; then
            echo "::error title=GitHub API Failure::âŒ Could not fetch labels from $REPO"
            exit 1
          fi

          echo "âœ… Existing labels fetched:"
          cat /tmp/existing-labels.json
          echo "::endgroup::"

      - name: ðŸ”„ Synchronize Labels
        id: sync_labels
        run: |
          set -euo pipefail
          echo "::group::â„¹ï¸ Creating or Updating Labels"

          jq -r '.[].name' /tmp/existing-labels.json > /tmp/existing-names.txt

          jq -c '.[]' /tmp/desired-labels.json | while read -r row; do
            NAME=$(jq -r '.name' <<<"$row")
            COLOR=$(jq -r '.color' <<<"$row")
            DESC=$(jq -r '.description // ""' <<<"$row")

            if grep -Fxq "$NAME" /tmp/existing-names.txt; then
              echo "â„¹ï¸ Updating label: $NAME"
              if [ "$DRY_RUN" != "true" ]; then
                if ! gh label edit "$NAME" --repo "$REPO" --color "$COLOR" --description "$DESC"; then
                  echo "::error title=Label Update Failed::âŒ Failed to update $NAME"
                  exit 1
                fi
              else
                echo "â„¹ï¸ Dry-run: update skipped"
              fi
            else
              echo "â„¹ï¸ Creating label: $NAME"
              if [ "$DRY_RUN" != "true" ]; then
                if ! gh label create "$NAME" --repo "$REPO" --color "$COLOR" --description "$DESC"; then
                  echo "::error title=Label Creation Failed::âŒ Failed to create $NAME"
                  exit 1
                fi
              else
                echo "â„¹ï¸ Dry-run: create skipped"
              fi
            fi
          done
          echo "::endgroup::"

      - name: ðŸ§¹ Remove Obsolete Labels
        id: cleanup_labels
        run: |
          set -euo pipefail
          echo "::group::ðŸ§¹ Removing Obsolete Labels"

          PROTECTED_LABELS=""

          if [ "$DRY_RUN" = "true" ]; then
            echo "::warning title=Cleanup Dry-run::âš ï¸ No labels will be deleted (Dry-run mode is active)"
          fi

          jq -r '.[].name' /tmp/existing-labels.json | while read -r LABEL; do
            case " $PROTECTED_LABELS " in
              *" $LABEL "*) echo "â„¹ï¸ Protected label: $LABEL â€” skipping"; continue;;
            esac

            if ! jq -r '.[].name' /tmp/desired-labels.json | grep -Fxq "$LABEL"; then
              echo "ðŸ—‘ï¸ Label not defined in labels.yml: $LABEL"
              if [ "$DRY_RUN" != "true" ]; then
                if ! gh label delete "$LABEL" --repo "$REPO" --yes; then
                  echo "::warning title=Label Delete Failed::âš ï¸ Label '$LABEL' may have already been removed"
                fi
              else
                echo "â„¹ï¸ Dry-run: delete skipped"
              fi
            fi
          done
          echo "::endgroup::"

      - name: ðŸ“Š Generate Job Summary
        if: always()
        run: |
          set -euo pipefail
          echo "::group::ðŸ“Š Generating Summary"

          # Determine statuses for the table
          LOAD_STATUS="${{ steps.load_labels.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }}"
          FETCH_STATUS="${{ steps.fetch_labels.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }}"
          SYNC_STATUS="${{ steps.sync_labels.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }}"
          CLEAN_STATUS="${{ steps.cleanup_labels.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }}"

          {
            echo "## ðŸ·ï¸ Label Synchronization Summary"
            echo ""
            echo "Execution completed at: $(date -u)"
            echo ""

            if [ "$DRY_RUN" = "true" ]; then
              echo "> [!IMPORTANT]"
              echo "> **Mode: Dry-run**. No changes were applied to the repository."
            else
              echo "### âœ… Mode: Active"
              echo "Repository labels have been synchronized with \`$LABELS_FILE\`."
            fi

            echo ""
            echo "### ðŸ“ˆ Execution Results"
            echo "| Task | Result |"
            echo "| :--- | :--- |"
            echo "| â„¹ï¸ Load Config | $LOAD_STATUS |"
            echo "| ðŸ” Fetch Existing | $FETCH_STATUS |"
            echo "| ðŸ”„ Sync Labels | $SYNC_STATUS |"
            echo "| ðŸ§¹ Cleanup | $CLEAN_STATUS |"

            echo ""
            echo "### ðŸ“Š Metrics"
            echo "| Metric | Value |"
            echo "| :--- | :--- |"

            DESIRED_COUNT=$( [ -f /tmp/desired-labels.json ] && jq '. | length' /tmp/desired-labels.json || echo "0" )
            EXISTING_COUNT=$( [ -f /tmp/existing-labels.json ] && jq '. | length' /tmp/existing-labels.json || echo "0" )

            echo "| ðŸ” Configured Labels | $DESIRED_COUNT |"
            echo "| ðŸ·ï¸ Existing Labels | $EXISTING_COUNT |"

            echo ""
            echo "### âš™ï¸ Runtime Configuration"
            echo "- **Repository:** $REPO"
            echo "- **Config Path:** $LABELS_FILE"
            echo "- **Triggered By:** ${{ github.actor }}"
            echo "- **Workflow Run:** [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          } >> "$GITHUB_STEP_SUMMARY"
          echo "::endgroup::"
