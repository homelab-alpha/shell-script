---
name: Manage Pull Request draft state

on:
  pull_request:
    types:
      - opened
      - ready_for_review
      - labeled
      - closed

  pull_request_review:
    types:
      - submitted

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  manage-state:
    runs-on: ubuntu-latest

    env:
      GITHUB_TOKEN: ${{ github.token }}
      PR_NUMBER: ${{ github.event.pull_request.number }}
      REPO: ${{ github.repository }}
      LABEL_EXTERNAL_FEEDBACK: 'has external feedback'
      LABEL_FIX_REQUESTED: 'PR: please address review comments'
      LABEL_IN_PROGRESS: 'in progress'
      LABEL_NEEDS_REVIEW: 'PR: needs review'

    steps:
      - name: Convert new Pull Request to draft
        if: |
          github.event_name == 'pull_request' &&
          github.event.action == 'opened'

        run: |
          echo "New Pull Request opened; converting Pull Request to draft…"
          IS_DRAFT=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json isDraft -q '.isDraft')

          if [ "$IS_DRAFT" = "false" ]; then
            echo "Converting PR to draft…"
            gh pr ready "$PR_NUMBER" --repo "$REPO" --undo
          else
            echo "PR already draft; skipping."
          fi

          echo "Updating labels…"
          gh pr edit "$PR_NUMBER" --repo "$REPO" \
            --add-label "$LABEL_IN_PROGRESS"

      - name: Handle changes requested (set PR to draft)
        if: |
          (
            github.event_name == 'pull_request' &&
            github.event.action == 'labeled' &&
            github.event.label.name == 'PR: please address review comments'
          ) ||

          (
            github.event_name == 'pull_request_review' &&
            github.event.review.state == 'changes_requested' &&
            (
              github.event.review.author_association == 'MEMBER' ||
              github.event.review.author_association == 'OWNER'
            )
          )

        run: |
          echo "Reviewer is maintainer; evaluating Pull Request state…"
          IS_DRAFT=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json isDraft -q '.isDraft')

          if [ "$IS_DRAFT" = "false" ]; then
            echo "Converting PR to draft…"
            gh pr ready "$PR_NUMBER" --repo "$REPO" --undo
          else
            echo "PR already draft; skipping."
          fi

          echo "Updating labels…"
          gh pr edit "$PR_NUMBER" --repo "$REPO" \
            --add-label "$LABEL_FIX_REQUESTED" \
            --add-label "$LABEL_IN_PROGRESS" \
            --remove-label "$LABEL_NEEDS_REVIEW" || true


      - name: Handle external review feedback (non-maintainers)
        if: |
          github.event_name == 'pull_request_review' &&
          github.event.review.state == 'changes_requested' &&
          github.event.review.author_association != 'MEMBER' &&
          github.event.review.author_association != 'OWNER'

        run: |
          echo "External reviewer requested changes; adding informational label…"
          gh pr edit "$PR_NUMBER" --repo "$REPO" \
            --add-label "$LABEL_EXTERNAL_FEEDBACK" || true

      - name: Handle ready for review
        if: github.event_name == 'pull_request' &&
            github.event.action == 'ready_for_review'

        run: |
          echo "Pull Request marked ready for review; updating labels…"
          gh pr edit "$PR_NUMBER" --repo "$REPO" \
            --remove-label "$LABEL_EXTERNAL_FEEDBACK" \
            --remove-label "$LABEL_FIX_REQUESTED" \
            --remove-label "$LABEL_IN_PROGRESS" \
            --add-label "$LABEL_NEEDS_REVIEW" || true

      - name: Handle merged Pull Request (cleanup labels)
        if: |
          github.event_name == 'pull_request' &&
          github.event.action == 'closed' &&
          github.event.pull_request.merged == true

        run: |
          echo "Pull Request merged; cleaning up labels…"
          gh pr edit "$PR_NUMBER" --repo "$REPO" \
            --remove-label "$LABEL_EXTERNAL_FEEDBACK" \
            --remove-label "$LABEL_FIX_REQUESTED" \
            --remove-label "$LABEL_IN_PROGRESS" \
            --remove-label "$LABEL_NEEDS_REVIEW" || true
