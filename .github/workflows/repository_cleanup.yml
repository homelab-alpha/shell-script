---
name: Repository Cleanup

on:
  schedule:
    - cron: 0 3 * * 0

  workflow_dispatch:
    inputs:
      dry_run:
        description: "Run in dry-run mode"
        required: true
        default: true
        type: boolean
      cache_retention_days:
        description: "Cache retention in days"
        required: true
        default: 7
        type: number
      workflow_retention_days:
        description: "Workflow retention in days"
        required: true
        default: 28
        type: number

permissions:
  actions: write
  contents: read

jobs:
  action:
    name: Repository Cleanup
    runs-on: ubuntu-latest

    env:
      GITHUB_TOKEN: ${{ github.token }}
      REPO: ${{ github.repository }}
      DRY_RUN:
        ${{ github.event_name == 'workflow_dispatch' &&
        github.event.inputs.dry_run || 'true' }}
      CACHE_RETENTION_DAYS:
        ${{ github.event_name == 'workflow_dispatch' &&
        github.event.inputs.cache_retention_days || '7' }}
      WORKFLOW_RETENTION_DAYS:
        ${{ github.event_name == 'workflow_dispatch' &&
        github.event.inputs.workflow_retention_days || '28' }}

    steps:
      - name: Cleanup old GitHub Actions caches
        run: |
          if [ "$DRY_RUN" = "true" ]; then
            echo "::notice title=DRY RUN Enabled::üß™ Cache cleanup will be simulated (no deletions)"
          else
            echo "::notice title=LIVE MODE Enabled::‚ö†Ô∏è Cache cleanup will delete data"
          fi

          echo ""
          echo "::notice title=Cache Cleanup Started::üßπ Cleaning up old GitHub Actions caches..."
          echo ""
          echo "‚ñ∂Ô∏è Repository: $REPO"
          echo "‚ÑπÔ∏è Retention policy: $CACHE_RETENTION_DAYS days"

          if [ "$CACHE_RETENTION_DAYS" -eq 0 ]; then
            CUTOFF_DATE=$(date -d "-1 minutes" +%s)
            echo "‚ÑπÔ∏è Minimum age enforced: 1 minutes"
          else
            CUTOFF_DATE=$(date -d "-$CACHE_RETENTION_DAYS days" +%s)
          fi

          gh api "/repos/$REPO/actions/caches" --paginate \
            | jq -r '.actions_caches[] | "\(.id) \(.last_accessed_at)"' \
            | while read -r CACHE_ID LAST_ACCESSED_AT; do
                CACHE_DATE=$(date -d "$LAST_ACCESSED_AT" +%s)

                if [ "$CACHE_DATE" -lt "$CUTOFF_DATE" ]; then
                  echo ""
                  echo "::notice title=Cache Eligible for Deletion::üóëÔ∏è Cache ID $CACHE_ID"
                  echo "üïí Last accessed at: $LAST_ACCESSED_AT"

                  if [ "$DRY_RUN" = "true" ]; then
                    echo "üß™ DRY RUN: cache $CACHE_ID would be deleted"
                  else
                    echo "‚ö†Ô∏è Deleting cache $CACHE_ID..."
                    gh api -X DELETE "/repos/$REPO/actions/caches/$CACHE_ID"
                  fi
                else
                  echo ""
                  echo "‚è≠Ô∏è Cache ID $CACHE_ID is still within retention window"
                fi
              done

          echo ""
          echo "::notice title=Cache Cleanup Finished::‚úÖ Cache cleanup completed"

      - name: Cleanup old workflow runs
        run: |
          if [ "$DRY_RUN" = "true" ]; then
            echo "::notice title=DRY RUN Enabled::üß™ Workflow run cleanup will be simulated (no deletions)"
          else
            echo "::notice title=LIVE MODE Enabled::‚ö†Ô∏è Workflow run cleanup will delete data"
          fi

          echo ""
          echo "::notice title=Workflow Cleanup Started::üßπ Cleaning up old workflow runs..."
          echo ""
          echo "‚ñ∂Ô∏è Repository: $REPO"
          echo "‚ÑπÔ∏è Retention policy: $WORKFLOW_RETENTION_DAYS days"

          if [ "$WORKFLOW_RETENTION_DAYS" -eq 0 ]; then
            CUTOFF_DATE=$(date -d "-1 minutes" +%s)
            echo "üõ°Ô∏è Minimum age enforced: 1 minutes"
          else
            CUTOFF_DATE=$(date -d "-$WORKFLOW_RETENTION_DAYS days" +%s)
          fi

          echo "üßÆ Effective cutoff: $(date -d "@$CUTOFF_DATE" --iso-8601=seconds)"

          gh api "/repos/$REPO/actions/runs" --paginate \
            | jq -r '.workflow_runs[] | "\(.id) \(.created_at)"' \
            | while read -r RUN_ID CREATED_AT; do
                RUN_DATE=$(date -d "$CREATED_AT" +%s)

                if [ "$RUN_DATE" -lt "$CUTOFF_DATE" ]; then
                  echo ""
                  echo "::notice title=Workflow Run Eligible for Deletion::üóëÔ∏è Run ID $RUN_ID"
                  echo "üïí Created at: $CREATED_AT"

                  if [ "$DRY_RUN" = "true" ]; then
                    echo "üß™ DRY RUN: workflow run $RUN_ID would be deleted"
                  else
                    echo "‚ö†Ô∏è Deleting workflow run $RUN_ID..."
                    gh api -X DELETE "/repos/$REPO/actions/runs/$RUN_ID"
                  fi
                else
                  echo ""
                  echo "‚è≠Ô∏è Workflow run ID $RUN_ID is still within retention window"
                fi
              done

          echo ""
          echo "::notice title=Workflow Cleanup Finished::‚úÖ Workflow run cleanup completed"
